service: jung2bot

frameworkVersion: '>=1.42.0 <2.0.0'

provider:
  name: aws
  runtime: nodejs8.10
  stage: ${env:STAGE, 'dev'}
  region: ${env:REGION, 'us-east-1'}
  profile: ${env:PROFILE, ''}
  logs:
    restApi: true
  logRetentionInDays: 3
  tracing:
    apiGateway: true
    lambda: true
  deploymentBucket:
    serverSideEncryption: AES256
  environment:
    LOG_LEVEL: ${env:LOG_LEVEL, 'error'}
    TELEGRAM_BOT_TOKEN: ${ssm:${self:service}-${self:provider.stage}-telegram-api-token~true}
    MESSAGE_TABLE: ${self:service}-${self:provider.stage}-messages
    CHATID_TABLE: ${self:service}-${self:provider.stage}-chatIds
    EVENT_QUEUE_URL: !Ref EventQueue
  tags:
    Name: jung2bot
  iamRoleStatements:
    - Effect: Allow
      Action:
        - 'dynamodb:*'
      Resource:
        - !GetAtt Jung2BotDynamoDB.Arn
        - !GetAtt ChatIDsDynamoDB.Arn
    - Effect: Allow
      Action:
        - 'sns:Publish'
      Resource:
        - !Ref MessagesDeadLetterTopic
        - !Ref OffFromWorkDeadLetterTopic
        - !Ref QueryEventDeadLetterTopic
    - Effect: Allow
      Action:
        - 'sqs:SendMessage'
      Resource:
        - !GetAtt EventQueue.Arn

functions:
  messages:
    handler: src/handler.onMessage
    # 2019-05-15 onMessage:
    # min: 87.738 mb
    # avg: 115.2237 mb
    # max: 116.3483 mb
    # peak duration: 7.2s
    timeout: 10
    memorySize: 128
    deadLetter:
      sns: ${self:service}-${self:provider.stage}-messages-dead-letter-topic
    events:
      - http:
          path: /
          method: post
  offFromWork:
    handler: src/handler.onOffFromWork
    # 2019-05-15 onOffFromWork:
    # min: 129.6997 mb
    # avg: 129.6997 mb
    # max: 129.6997 mb
    # peak duration: 75.3s
    timeout: 600
    memorySize: 256
    deadLetter:
      sns: ${self:service}-${self:provider.stage}-offFromWork-dead-letter-topic
    events:
      - schedule: cron(0 10 ? * MON-FRI *) # 10 am UTC = 6 pm HKT
  queryEvent:
    handler: src/handler.onEvent
    # 2019-05-15 onEvent:
    # min: 119.2093 mb
    # avg: 150.016 mb
    # max: 228.8818 mb
    # peak duration: 44.5s
    timeout: 60
    memorySize: 320
    # https://core.telegram.org/bots/faq#my-bot-is-hitting-limits-how-do-i-avoid-this
    # If you're sending bulk notifications to multiple users, the API will not allow more than 30 messages
    # per second or so. Consider spreading out notifications over large intervals of 8â€”12 hours for best results.
    # Also note that your bot will not be able to send more than 20 messages per minute to the same group.
    reservedConcurrency: 25
    deadLetter:
      sns: ${self:service}-${self:provider.stage}-queryEvent-dead-letter-topic
    events:
      - sqs:
          arn: !GetAtt EventQueue.Arn
  scaleUpBeforeOffFromWork:
    handler: src/handler.onScaleUp
    # 2019-05-15 onOffFromWork:
    # min: ?? mb
    # avg: ?? mb
    # max: ?? mb
    # peak duration: ??s
    timeout: 60
    memorySize: 128
    deadLetter:
      sns: ${self:service}-${self:provider.stage}-scaleUpBeforeOffFromWork-dead-letter-topic
    events:
      - schedule: cron(59 9 ? * MON-FRI *) # 9:59 am UTC = 5:59 pm HKT

plugins:
  - serverless-domain-manager
  - serverless-dotenv-plugin
  - serverless-plugin-lambda-dead-letter
  - serverless-plugin-dynamodb-autoscaling
  - serverless-webpack
  - serverless-dynamodb-local
  - serverless-offline

custom:
  jung2bot:
    MESSAGE_TABLE_GSI: chatId-dateCreated-GSI
  # serverless-domain-manager
  customDomain:
    domainName: ${env:DOMAIN}
    stage: ${self:provider.stage}
    createRoute53Record: true
    endpointType: edge
  # serverless-dynamodb-local
  dynamodb:
    start:
      seed: true
      migrate: true
    seed:
      domain:
        sources:
          - table: ${self:service}-${self:provider.stage}-messages
            sources: [./test/helper/dynamodbMessagesSeed.json]
          - table: ${self:service}-${self:provider.stage}-chatIds
            sources: [./test/helper/dynamodbChatIdSeed.json]
  # serverless-plugin-dynamodb-autoscaling
  dynamodbAutoscaling:
    tablesConfig:
      Jung2BotDynamoDB:
        minCapacity: 1
        maxCapacity: 1000
      ChatIDsDynamoDB:
        minCapacity: 1
        maxCapacity: 1000

resources:
  Resources:
    # Messages DynamoDB Table
    Jung2BotDynamoDB:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        AttributeDefinitions:
          - AttributeName: chatId
            AttributeType: N
          - AttributeName: dateCreated
            AttributeType: S
        KeySchema:
          - AttributeName: chatId
            KeyType: HASH
          - AttributeName: dateCreated
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        TableName: ${self:service}-${self:provider.stage}-messages
    # ChatId DynamoDB Table
    ChatIDsDynamoDB:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        AttributeDefinitions:
          - AttributeName: chatId
            AttributeType: N
        KeySchema:
          - AttributeName: chatId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        TableName: ${self:service}-${self:provider.stage}-chatIds
    # SQS for handling query events
    EventQueue:
      Type: AWS::SQS::Queue
      Properties:
        VisibilityTimeout: 70
        KmsDataKeyReusePeriodSeconds: 86400
        KmsMasterKeyId: alias/aws/sqs
